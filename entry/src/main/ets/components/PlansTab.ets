/**
 * è®¡åˆ’ä¸ç›®æ ‡ Tab ç»„ä»¶
 * åŠŸèƒ½ï¼šåˆ›å»º/æŸ¥çœ‹é¡¹ç›®ã€è¿›åº¦å¯è§†åŒ–
 */
import curves from '@ohos.curves'
import router from '@ohos.router'
import { PreferencesUtil } from '../utils/PreferencesUtil'
import { FocusProject } from '../model/DataModels'

@Component
export struct PlansTab {
  @State projects: FocusProject[] = []
  @State showCreateForm: boolean = false

  // åˆ›å»ºè¡¨å•å­—æ®µ
  @State formName: string = ''
  @State formDesc: string = ''
  @State formTotalHours: string = ''
  @State formDailyHours: string = ''
  @State formTotalDays: string = ''

  // åŠ¨ç”»çŠ¶æ€
  @State headerScale: number = 0
  @State headerOpacity: number = 0
  @State listScales: number[] = []
  @State listOpacities: number[] = []
  @State formScale: number = 0
  @State formOpacity: number = 0

  aboutToAppear(): void {
    this.loadProjects()
    this.playEntranceAnimation()
  }

  private async loadProjects(): Promise<void> {
    this.projects = await PreferencesUtil.getProjects()
    // åˆå§‹åŒ–åˆ—è¡¨åŠ¨ç”»çŠ¶æ€
    this.listScales = []
    this.listOpacities = []
    for (let i = 0; i < this.projects.length; i++) {
      this.listScales.push(0)
      this.listOpacities.push(0)
    }

    // åˆ—è¡¨é¡¹é€ä¸ªå¼¹æ€§å…¥åœº
    for (let i = 0; i < this.projects.length; i++) {
      let delay = 400 + i * 100
      setTimeout(() => {
        animateTo({
          duration: 700,
          curve: curves.springCurve(0, 1, 300, 30)
        }, () => {
          if (i < this.listScales.length) {
            this.listScales[i] = 1
            this.listOpacities[i] = 1
          }
        })
      }, delay)
    }
  }

  private playEntranceAnimation(): void {
    setTimeout(() => {
      animateTo({
        duration: 700,
        curve: curves.springCurve(0, 1, 328, 34)
      }, () => {
        this.headerScale = 1
        this.headerOpacity = 1
      })
    }, 100)
  }

  private async createProject(): Promise<void> {
    if (this.formName.trim() === '') return

    let project: FocusProject = {
      id: PreferencesUtil.generateId(),
      name: this.formName.trim(),
      description: this.formDesc.trim(),
      totalGoalHours: parseFloat(this.formTotalHours) || 0,
      dailyGoalHours: parseFloat(this.formDailyHours) || 0,
      totalGoalDays: parseInt(this.formTotalDays) || 0,
      completedMinutes: 0,
      completedDays: 0,
      createdAt: Date.now(),
      isActive: true
    }

    await PreferencesUtil.saveProject(project)
    this.showCreateForm = false
    this.resetForm()
    this.loadProjects()
  }

  private resetForm(): void {
    this.formName = ''
    this.formDesc = ''
    this.formTotalHours = ''
    this.formDailyHours = ''
    this.formTotalDays = ''
  }

  build() {
    Scroll() {
      Column() {
        // æ ‡é¢˜æ 
        Row() {
          Text('è®¡åˆ’ä¸ç›®æ ‡')
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor($r('app.color.text_primary'))

          Blank()

          Button('+ æ–°å»º')
            .height(36)
            .fontSize(14)
            .fontWeight(FontWeight.Bold)
            .backgroundColor($r('app.color.primary_green'))
            .fontColor(Color.White)
            .borderRadius(18)
            .onClick(() => {
              this.showCreateForm = !this.showCreateForm
              if (this.showCreateForm) {
                this.formScale = 0
                this.formOpacity = 0
                setTimeout(() => {
                  animateTo({
                    duration: 600,
                    curve: curves.springCurve(0, 1, 300, 28)
                  }, () => {
                    this.formScale = 1
                    this.formOpacity = 1
                  })
                }, 50)
              }
            })
        }
        .width('100%')
        .padding({ left: 20, right: 20, top: 16, bottom: 8 })
        .scale({ x: this.headerScale, y: this.headerScale })
        .opacity(this.headerOpacity)

        // åˆ›å»ºè¡¨å•
        if (this.showCreateForm) {
          Column() {
            Text('åˆ›å»ºæ–°é¡¹ç›®')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor($r('app.color.text_primary'))
              .margin({ bottom: 16 })

            // é¡¹ç›®åç§°
            TextInput({ placeholder: 'é¡¹ç›®åç§°ï¼ˆå¦‚ï¼šå­¦ä¹ è‹±è¯­ï¼‰' })
              .width('100%')
              .height(44)
              .fontSize(14)
              .backgroundColor($r('app.color.bg_surface'))
              .borderRadius(12)
              .margin({ bottom: 12 })
              .onChange((value: string) => { this.formName = value })

            // é¡¹ç›®æè¿°
            TextInput({ placeholder: 'é¡¹ç›®æè¿°' })
              .width('100%')
              .height(44)
              .fontSize(14)
              .backgroundColor($r('app.color.bg_surface'))
              .borderRadius(12)
              .margin({ bottom: 12 })
              .onChange((value: string) => { this.formDesc = value })

            Row() {
              TextInput({ placeholder: 'æ€»ç›®æ ‡(å°æ—¶)' })
                .layoutWeight(1)
                .height(44)
                .fontSize(14)
                .type(InputType.Number)
                .backgroundColor($r('app.color.bg_surface'))
                .borderRadius(12)
                .margin({ right: 8 })
                .onChange((value: string) => { this.formTotalHours = value })

              TextInput({ placeholder: 'æ¯æ—¥ç›®æ ‡(å°æ—¶)' })
                .layoutWeight(1)
                .height(44)
                .fontSize(14)
                .type(InputType.Number)
                .backgroundColor($r('app.color.bg_surface'))
                .borderRadius(12)
                .onChange((value: string) => { this.formDailyHours = value })
            }
            .width('100%')
            .margin({ bottom: 12 })

            TextInput({ placeholder: 'æ€»å¤©æ•°ï¼ˆå¦‚ï¼š30å¤©ï¼‰' })
              .width('100%')
              .height(44)
              .fontSize(14)
              .type(InputType.Number)
              .backgroundColor($r('app.color.bg_surface'))
              .borderRadius(12)
              .margin({ bottom: 16 })
              .onChange((value: string) => { this.formTotalDays = value })

            Row() {
              Button('å–æ¶ˆ')
                .layoutWeight(1)
                .height(44)
                .fontSize(14)
                .backgroundColor($r('app.color.bg_surface'))
                .fontColor($r('app.color.text_secondary'))
                .borderRadius(22)
                .margin({ right: 12 })
                .onClick(() => {
                  this.showCreateForm = false
                  this.resetForm()
                })

              Button('åˆ›å»º')
                .layoutWeight(1)
                .height(44)
                .fontSize(14)
                .fontWeight(FontWeight.Bold)
                .backgroundColor($r('app.color.primary_green'))
                .fontColor(Color.White)
                .borderRadius(22)
                .onClick(() => { this.createProject() })
            }
            .width('100%')
          }
          .width('100%')
          .padding(20)
          .margin({ left: 16, right: 16, bottom: 12 })
          .backgroundColor($r('app.color.bg_card'))
          .borderRadius(20)
          .shadow({ radius: 8, color: $r('app.color.shadow_color'), offsetY: 2 })
          .scale({ x: this.formScale, y: this.formScale })
          .opacity(this.formOpacity)
        }

        // é¡¹ç›®åˆ—è¡¨
        if (this.projects.length === 0) {
          Column() {
            Text('ğŸ“‹')
              .fontSize(48)
              .margin({ bottom: 12 })
            Text('è¿˜æ²¡æœ‰é¡¹ç›®')
              .fontSize(16)
              .fontColor($r('app.color.text_hint'))
            Text('ç‚¹å‡»å³ä¸Šè§’"+ æ–°å»º"åˆ›å»ºä½ çš„ç¬¬ä¸€ä¸ªé¡¹ç›®')
              .fontSize(13)
              .fontColor($r('app.color.text_hint'))
              .margin({ top: 8 })
          }
          .width('100%')
          .padding({ top: 80 })
        } else {
          ForEach(this.projects, (project: FocusProject, index: number) => {
            Column() {
              // é¡¹ç›®åç§°å’ŒçŠ¶æ€
              Row() {
                Column() {
                  Text(project.name)
                    .fontSize(18)
                    .fontWeight(FontWeight.Bold)
                    .fontColor($r('app.color.text_primary'))
                  if (project.description !== '') {
                    Text(project.description)
                      .fontSize(13)
                      .fontColor($r('app.color.text_secondary'))
                      .margin({ top: 4 })
                      .maxLines(1)
                      .textOverflow({ overflow: TextOverflow.Ellipsis })
                  }
                }
                .layoutWeight(1)
                .alignItems(HorizontalAlign.Start)

                Text(project.isActive ? 'è¿›è¡Œä¸­' : 'å·²å®Œæˆ')
                  .fontSize(12)
                  .fontColor(project.isActive ? $r('app.color.primary_green') : $r('app.color.text_hint'))
                  .backgroundColor(project.isActive ? $r('app.color.primary_green_light') : $r('app.color.bg_surface'))
                  .padding({ left: 10, right: 10, top: 4, bottom: 4 })
                  .borderRadius(12)
              }
              .width('100%')
              .margin({ bottom: 16 })

              // è¿›åº¦æ¡ - æ—¶é•¿
              if (project.totalGoalHours > 0) {
                Column() {
                  Row() {
                    Text('æ—¶é•¿è¿›åº¦')
                      .fontSize(12)
                      .fontColor($r('app.color.text_secondary'))
                    Blank()
                    Text(`${PreferencesUtil.formatDuration(project.completedMinutes)} / ${project.totalGoalHours}å°æ—¶`)
                      .fontSize(12)
                      .fontColor($r('app.color.text_secondary'))
                  }
                  .width('100%')

                  Progress({
                    value: project.completedMinutes,
                    total: project.totalGoalHours * 60,
                    type: ProgressType.Linear
                  })
                    .width('100%')
                    .height(8)
                    .color($r('app.color.primary_green'))
                    .backgroundColor($r('app.color.progress_track'))
                    .borderRadius(4)
                    .margin({ top: 6 })
                }
                .margin({ bottom: 12 })
              }

              // æ¯æ—¥ç›®æ ‡å’Œå…¶ä»–ä¿¡æ¯
              Row() {
                if (project.dailyGoalHours > 0) {
                  Column() {
                    Text(`${project.dailyGoalHours}h`)
                      .fontSize(16)
                      .fontWeight(FontWeight.Bold)
                      .fontColor($r('app.color.primary_blue'))
                    Text('æ¯æ—¥ç›®æ ‡')
                      .fontSize(10)
                      .fontColor($r('app.color.text_hint'))
                  }
                  .layoutWeight(1)
                }

                if (project.totalGoalDays > 0) {
                  Column() {
                    Text(`${project.completedDays}/${project.totalGoalDays}`)
                      .fontSize(16)
                      .fontWeight(FontWeight.Bold)
                      .fontColor($r('app.color.accent_orange'))
                    Text('å¤©æ•°')
                      .fontSize(10)
                      .fontColor($r('app.color.text_hint'))
                  }
                  .layoutWeight(1)
                }

                Column() {
                  Text(PreferencesUtil.formatDuration(project.completedMinutes))
                    .fontSize(16)
                    .fontWeight(FontWeight.Bold)
                    .fontColor($r('app.color.primary_green'))
                  Text('å·²å®Œæˆ')
                    .fontSize(10)
                    .fontColor($r('app.color.text_hint'))
                }
                .layoutWeight(1)
              }
            }
            .width('100%')
            .padding(20)
            .margin({ left: 16, right: 16, bottom: 12 })
            .backgroundColor($r('app.color.bg_card'))
            .borderRadius(20)
            .shadow({ radius: 8, color: $r('app.color.shadow_color'), offsetY: 2 })
            .scale({
              x: index !== undefined && index < this.listScales.length ? this.listScales[index] : 1,
              y: index !== undefined && index < this.listScales.length ? this.listScales[index] : 1
            })
            .opacity(index !== undefined && index < this.listOpacities.length ? this.listOpacities[index] : 1)
            .onClick(() => {
              router.pushUrl({
                url: 'pages/ProjectDetailPage',
                params: { projectId: project.id }
              })
            })
          })
        }
      }
      .width('100%')
      .padding({ bottom: 20 })
    }
    .width('100%')
    .height('100%')
    .scrollBar(BarState.Off)
    .edgeEffect(EdgeEffect.Spring)
  }
}
