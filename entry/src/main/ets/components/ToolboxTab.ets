/**
 * Â∑•ÂÖ∑ÁÆ± Tab ÁªÑ‰ª∂
 * 8 Â§ß‰∏ìÊ≥®Â∑•ÂÖ∑ + ËÆæÁΩÆÔºàÊ∑±Ëâ≤Ê®°ÂºèÔºâ
 */
import curves from '@ohos.curves'
import router from '@ohos.router'
import ConfigurationConstant from '@ohos.app.ability.ConfigurationConstant'
import common from '@ohos.app.ability.common'

@Component
export struct ToolboxTab {
  @Consume('refreshCounter') @Watch('onRefresh') refreshCounter: number
  @State isDarkMode: boolean = false

  // Âä®ÁîªÁä∂ÊÄÅ
  @State headerScale: number = 0
  @State headerOpacity: number = 0
  @State gridScales: number[] = [0, 0, 0, 0, 0, 0, 0, 0]
  @State gridOpacities: number[] = [0, 0, 0, 0, 0, 0, 0, 0]
  @State settingsScale: number = 0
  @State settingsOpacity: number = 0

  aboutToAppear(): void {
    this.playEntranceAnimation()
  }

  onRefresh(): void {
  }

  private playEntranceAnimation(): void {
    setTimeout(() => {
      animateTo({
        duration: 700, curve: curves.springCurve(0, 1, 328, 34)
      }, () => {
        this.headerScale = 1
        this.headerOpacity = 1
      })
    }, 100)

    // Â∑•ÂÖ∑Âç°ÁâáÈÄê‰∏™ÂºπÂÖ•
    for (let i = 0; i < 8; i++) {
      let delay = 200 + i * 60
      setTimeout(() => {
        animateTo({
          duration: 600, curve: curves.springCurve(0, 1, 300, 28)
        }, () => {
          this.gridScales[i] = 1
          this.gridOpacities[i] = 1
        })
      }, delay)
    }

    setTimeout(() => {
      animateTo({
        duration: 500, curve: curves.springCurve(0, 1, 280, 26)
      }, () => {
        this.settingsScale = 1
        this.settingsOpacity = 1
      })
    }, 750)
  }

  private applyColorMode(isDark: boolean): void {
    try {
      let context = getContext(this) as common.UIAbilityContext
      if (isDark) {
        context.getApplicationContext().setColorMode(ConfigurationConstant.ColorMode.COLOR_MODE_DARK)
      } else {
        context.getApplicationContext().setColorMode(ConfigurationConstant.ColorMode.COLOR_MODE_LIGHT)
      }
    } catch (e) {
    }
  }

  private getToolIcon(index: number): string {
    let icons: string[] = ['üéµ', 'ü´Å', '‚≠ê', 'üìñ', 'üèÜ', 'üìä', 'üéØ', 'üìµ']
    return icons[index]
  }

  private getToolName(index: number): string {
    let names: string[] = ['ÁôΩÂô™Èü≥', 'ÂëºÂê∏ÁªÉ‰π†', '‰∏ìÊ≥®ËØÑÂàÜ', '‰∏ìÊ≥®Êó•ËÆ∞', 'ÊØèÊó•ÊåëÊàò', '‰∏ìÊ≥®Êä•Âëä', 'ÁõÆÊ†áËøΩË∏™', 'ÊàíÊñ≠ÊâãÊú∫']
    return names[index]
  }

  private getToolDesc(index: number): string {
    let descs: string[] = [
      'Èõ®Â£∞/ÂíñÂï°ÂéÖÁéØÂ¢ÉÈü≥',
      '1-3ÂàÜÈíüÂºïÂØºÂëºÂê∏',
      'Ëá™ËØÑ1-5Êòü+‰∏≠Êñ≠ÂéüÂõ†',
      'ÁÆÄÁü≠Â§çÁõò‰ªäÊó•ÊàêÊûú',
      'ËøûÁª≠7Â§©Ëß£ÈîÅÊàêÂ∞±',
      'Âë®/ÊúàÊó∂ÊÆµÂàÜÂ∏É',
      'Êú¨Âë®ËÆ°ÂàíÂÆåÊàêËøõÂ∫¶',
      '‰øùÊåÅÁïåÈù¢ËÆ°Êó∂ÊàíÊñ≠'
    ]
    return descs[index]
  }

  private getToolColor(index: number): string {
    let colors: string[] = [
      '#E3F2FD', '#E8F5E9', '#FFF3E0', '#F3E5F5',
      '#FFF8E1', '#E0F2F1', '#FCE4EC', '#EFEBE9'
    ]
    return colors[index]
  }

  private getToolRoute(index: number): string {
    let routes: string[] = [
      'pages/WhiteNoisePage',
      'pages/BreathingPage',
      'pages/FocusRatingPage',
      'pages/FocusDiaryPage',
      'pages/ChallengesPage',
      'pages/FocusReportPage',
      'pages/GoalTrackingPage',
      'pages/PhoneDetoxPage'
    ]
    return routes[index]
  }

  build() {
    Column() {
      // Ê†áÈ¢ò
      Row() {
        Text('Â∑•ÂÖ∑ÁÆ±')
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .fontColor($r('app.color.text_primary'))
      }
      .width('100%')
      .padding({ left: 20, right: 20, top: 16, bottom: 12 })
      .scale({ x: this.headerScale, y: this.headerScale })
      .opacity(this.headerOpacity)

      Scroll() {
        Column() {
          // Â∑•ÂÖ∑ÁΩëÊ†º (2Âàó4Ë°å)
          Flex({ wrap: FlexWrap.Wrap, justifyContent: FlexAlign.SpaceBetween }) {
            ForEach([0, 1, 2, 3, 4, 5, 6, 7], (index: number) => {
              Column() {
                Text(this.getToolIcon(index))
                  .fontSize(32)
                  .margin({ bottom: 8 })

                Text(this.getToolName(index))
                  .fontSize(15)
                  .fontWeight(FontWeight.Bold)
                  .fontColor($r('app.color.text_primary'))

                Text(this.getToolDesc(index))
                  .fontSize(11)
                  .fontColor($r('app.color.text_secondary'))
                  .margin({ top: 4 })
                  .textAlign(TextAlign.Center)
                  .maxLines(2)
              }
              .width('47%')
              .padding({ top: 20, bottom: 20, left: 12, right: 12 })
              .margin({ bottom: 12 })
              .backgroundColor($r('app.color.bg_card'))
              .borderRadius(20)
              .alignItems(HorizontalAlign.Center)
              .shadow({ radius: 6, color: $r('app.color.shadow_color'), offsetY: 2 })
              .scale({
                x: index < this.gridScales.length ? this.gridScales[index] : 1,
                y: index < this.gridScales.length ? this.gridScales[index] : 1
              })
              .opacity(index < this.gridOpacities.length ? this.gridOpacities[index] : 1)
              .onClick(() => {
                router.pushUrl({ url: this.getToolRoute(index) })
              })
            })
          }
          .width('100%')
          .padding({ left: 16, right: 16 })

          // ËÆæÁΩÆÂå∫Âüü
          Column() {
            Text('ËÆæÁΩÆ')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor($r('app.color.text_primary'))
              .width('100%')
              .margin({ bottom: 16 })

            Row() {
              Column() {
                Text('Ê∑±Ëâ≤Ê®°Âºè')
                  .fontSize(16)
                  .fontColor($r('app.color.text_primary'))
                Text('ÂàáÊç¢Ê∑±Ëâ≤‰∏ªÈ¢ò')
                  .fontSize(12)
                  .fontColor($r('app.color.text_secondary'))
                  .margin({ top: 4 })
              }
              .layoutWeight(1)
              .alignItems(HorizontalAlign.Start)

              Toggle({ type: ToggleType.Switch, isOn: this.isDarkMode })
                .selectedColor($r('app.color.primary_green'))
                .switchPointColor(Color.White)
                .onChange((isOn: boolean) => {
                  this.isDarkMode = isOn
                  this.applyColorMode(isOn)
                })
            }
            .width('100%')
          }
          .width('100%')
          .padding(20)
          .margin({ left: 16, right: 16, top: 4, bottom: 40 })
          .backgroundColor($r('app.color.bg_card'))
          .borderRadius(20)
          .shadow({ radius: 8, color: $r('app.color.shadow_color'), offsetY: 2 })
          .scale({ x: this.settingsScale, y: this.settingsScale })
          .opacity(this.settingsOpacity)
        }
        .width('100%')
      }
      .layoutWeight(1)
      .scrollBar(BarState.Off)
      .edgeEffect(EdgeEffect.Spring)
      .align(Alignment.Top)
    }
    .width('100%')
    .height('100%')
  }
}
