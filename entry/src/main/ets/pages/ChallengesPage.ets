/**
 * æ¯æ—¥ä¸“æ³¨æŒ‘æˆ˜é¡µé¢
 * è¿žç»­7å¤©å®Œæˆç›®æ ‡è§£é”æˆå°±
 */
import router from '@ohos.router'
import curves from '@ohos.curves'
import { PreferencesUtil } from '../utils/PreferencesUtil'
import { UserGrowth } from '../model/DataModels'

@Entry
@Component
struct ChallengesPage {
  @State growth: UserGrowth = { totalPoints: 0, treeStage: 0, totalFocusMinutes: 0, currentStreak: 0, longestStreak: 0, lastActiveDate: '' }
  @State todayMinutes: number = 0
  @State headerScale: number = 0
  @State headerOpacity: number = 0
  @State bodyScale: number = 0
  @State bodyOpacity: number = 0

  aboutToAppear(): void {
    this.loadData()
    setTimeout(() => {
      animateTo({ duration: 700, curve: curves.springCurve(0, 1, 328, 34) }, () => { this.headerScale = 1; this.headerOpacity = 1 })
    }, 100)
    setTimeout(() => {
      animateTo({ duration: 800, curve: curves.springCurve(0, 1, 300, 28) }, () => { this.bodyScale = 1; this.bodyOpacity = 1 })
    }, 250)
  }

  private async loadData(): Promise<void> {
    this.growth = await PreferencesUtil.getUserGrowth()
    this.todayMinutes = await PreferencesUtil.getTodayFocusMinutes()
  }

  private isDayCompleted(dayIndex: number): boolean {
    return dayIndex < this.growth.currentStreak
  }

  private getAchievementStatus(required: number): string {
    return this.growth.longestStreak >= required ? 'âœ… å·²è§£é”' : `ðŸ”’ éœ€è¿žç»­${required}å¤©`
  }

  build() {
    Column() {
      Row() {
        Button('â†').width(40).height(40).fontSize(20)
          .backgroundColor($r('app.color.bg_surface')).fontColor($r('app.color.text_primary'))
          .borderRadius(20).onClick(() => { router.back() })
        Text('æ¯æ—¥æŒ‘æˆ˜').fontSize(20).fontWeight(FontWeight.Bold)
          .fontColor($r('app.color.text_primary')).margin({ left: 12 }).layoutWeight(1)
      }.width('100%').padding({ left: 16, right: 16, top: 12, bottom: 8 })
        .scale({ x: this.headerScale, y: this.headerScale }).opacity(this.headerOpacity)

      Scroll() {
        Column() {
          // ä»Šæ—¥è¿›åº¦
          Column() {
            Text('ðŸ”¥ ä»Šæ—¥æŒ‘æˆ˜').fontSize(18).fontWeight(FontWeight.Bold)
              .fontColor($r('app.color.text_primary')).width('100%').margin({ bottom: 12 })
            Text(`ä»Šæ—¥å·²ä¸“æ³¨: ${PreferencesUtil.formatDuration(this.todayMinutes)}`)
              .fontSize(16).fontColor($r('app.color.primary_green')).fontWeight(FontWeight.Bold)
            Progress({ value: Math.min(this.todayMinutes, 60), total: 60, type: ProgressType.Linear })
              .width('100%').height(10).color($r('app.color.primary_green'))
              .backgroundColor($r('app.color.progress_track')).borderRadius(5).margin({ top: 12 })
            Text(this.todayMinutes >= 60 ? 'âœ… ä»Šæ—¥æŒ‘æˆ˜å®Œæˆï¼' : `ç›®æ ‡: ä¸“æ³¨60åˆ†é’Ÿ (è¿˜å·®${Math.max(0, 60 - Math.round(this.todayMinutes))}åˆ†é’Ÿ)`)
              .fontSize(13).fontColor($r('app.color.text_secondary')).margin({ top: 8 })
          }.width('100%').padding(20).margin({ left: 16, right: 16, bottom: 12 })
            .backgroundColor($r('app.color.bg_card')).borderRadius(20)
            .shadow({ radius: 6, color: $r('app.color.shadow_color'), offsetY: 2 })

          // 7å¤©è¿žç»­æŒ‘æˆ˜
          Column() {
            Text('ðŸ“… 7å¤©è¿žç»­æŒ‘æˆ˜').fontSize(18).fontWeight(FontWeight.Bold)
              .fontColor($r('app.color.text_primary')).width('100%').margin({ bottom: 16 })
            Row() {
              ForEach([1, 2, 3, 4, 5, 6, 7], (day: number) => {
                Column() {
                  Text(this.isDayCompleted(day - 1) ? 'âœ…' : (day === this.growth.currentStreak + 1 ? 'ðŸ”¥' : 'â¬œ'))
                    .fontSize(24)
                  Text(`D${day}`).fontSize(11).fontColor($r('app.color.text_hint')).margin({ top: 4 })
                }.layoutWeight(1)
              })
            }.width('100%')
            Text(`å½“å‰è¿žç»­: ${this.growth.currentStreak}å¤© | æœ€é•¿: ${this.growth.longestStreak}å¤©`)
              .fontSize(13).fontColor($r('app.color.text_secondary')).margin({ top: 12 })
          }.width('100%').padding(20).margin({ left: 16, right: 16, bottom: 12 })
            .backgroundColor($r('app.color.bg_card')).borderRadius(20)
            .shadow({ radius: 6, color: $r('app.color.shadow_color'), offsetY: 2 })

          // æˆå°±åˆ—è¡¨
          Column() {
            Text('ðŸ† æˆå°±').fontSize(18).fontWeight(FontWeight.Bold)
              .fontColor($r('app.color.text_primary')).width('100%').margin({ bottom: 12 })

            ForEach([
              { name: 'åˆæ¬¡å°è¯•', desc: 'å®Œæˆç¬¬ä¸€æ¬¡ä¸“æ³¨', req: 1 },
              { name: 'ä¸‰å¤©åšæŒ', desc: 'è¿žç»­ä¸“æ³¨3å¤©', req: 3 },
              { name: 'ä¸€å‘¨è¾¾äºº', desc: 'è¿žç»­ä¸“æ³¨7å¤©', req: 7 },
              { name: 'åŠæœˆä¹‹æ˜Ÿ', desc: 'è¿žç»­ä¸“æ³¨15å¤©', req: 15 },
              { name: 'æœˆåº¦å† å†›', desc: 'è¿žç»­ä¸“æ³¨30å¤©', req: 30 }
            ], (item: AchievementItem) => {
              Row() {
                Column() {
                  Text(item.name).fontSize(15).fontWeight(FontWeight.Bold)
                    .fontColor($r('app.color.text_primary'))
                  Text(item.desc).fontSize(12).fontColor($r('app.color.text_secondary')).margin({ top: 2 })
                }.layoutWeight(1).alignItems(HorizontalAlign.Start)
                Text(this.getAchievementStatus(item.req))
                  .fontSize(12).fontColor(this.growth.longestStreak >= item.req ?
                  $r('app.color.success_green') : $r('app.color.text_hint'))
              }.width('100%').padding({ top: 12, bottom: 12 })
                .border({ width: { bottom: 0.5 }, color: $r('app.color.divider') })
            })
          }.width('100%').padding(20).margin({ left: 16, right: 16, bottom: 40 })
            .backgroundColor($r('app.color.bg_card')).borderRadius(20)
            .shadow({ radius: 6, color: $r('app.color.shadow_color'), offsetY: 2 })
        }.width('100%')
      }.layoutWeight(1).scrollBar(BarState.Off).edgeEffect(EdgeEffect.Spring).align(Alignment.Top)
        .scale({ x: this.bodyScale, y: this.bodyScale }).opacity(this.bodyOpacity)
    }.width('100%').height('100%').backgroundColor($r('app.color.bg_page'))
  }
}

interface AchievementItem {
  name: string
  desc: string
  req: number
}
