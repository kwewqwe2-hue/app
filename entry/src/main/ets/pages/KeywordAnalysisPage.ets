/**
 * å…³é”®è¯åˆ†æé¡µï¼ˆäºŒçº§é¡µé¢ï¼‰
 * ä¸ä½¿ç”¨è‡ªå®šä¹‰ç»„ä»¶ï¼Œæ‰€æœ‰ UI åœ¨ ArkUI ä¸­ç›´æ¥æ„å»º
 * å¯¹é•¿æœŸè®¡åˆ’å’ŒçŸ­æœŸå¤‡å¿˜è¿›è¡Œåˆ†è¯åˆ†æï¼Œå±•ç¤ºå…³é”®è¯çƒ­åº¦è¡¨
 */
import router from '@ohos.router'
import curves from '@ohos.curves'
import { PreferencesUtil } from '../utils/PreferencesUtil'
import { FocusNote } from '../model/DataModels'
import { PointsCalculator, KeywordResult } from '../utils/PointsCalculator'

@Entry
@Component
struct KeywordAnalysisPage {
  @State keywords: KeywordResult[] = []
  @State maxCount: number = 1
  @State totalNotes: number = 0
  @State totalWords: number = 0

  // åŠ¨ç”»çŠ¶æ€
  @State headerScale: number = 0
  @State headerOpacity: number = 0
  @State summaryScale: number = 0
  @State summaryOpacity: number = 0
  @State chartScale: number = 0
  @State chartOpacity: number = 0
  @State barScales: number[] = []

  aboutToAppear(): void {
    this.analyzeKeywords()
    this.playEntranceAnimation()
  }

  private async analyzeKeywords(): Promise<void> {
    let notes = await PreferencesUtil.getNotes()
    let relevantNotes = notes.filter((n: FocusNote) =>
      n.type === 'longterm' || n.type === 'shortterm'
    )
    this.totalNotes = relevantNotes.length

    let texts: string[] = []
    for (let note of relevantNotes) {
      if (note.title !== '') texts.push(note.title)
      if (note.content !== '') texts.push(note.content)
    }

    this.keywords = PointsCalculator.analyzeKeywords(texts)
    if (this.keywords.length > 0) {
      this.maxCount = this.keywords[0].count
    }

    // ç»Ÿè®¡æ€»è¯æ•°
    this.totalWords = 0
    for (let kw of this.keywords) {
      this.totalWords += kw.count
    }

    // åˆå§‹åŒ–æŸ±çŠ¶å›¾åŠ¨ç”»
    this.barScales = []
    for (let i = 0; i < this.keywords.length; i++) {
      this.barScales.push(0)
    }

    // é€ä¸ªæŸ±å­å¼¹æ€§å…¥åœº
    for (let i = 0; i < this.keywords.length; i++) {
      let delay = 600 + i * 60
      setTimeout(() => {
        animateTo({
          duration: 800,
          curve: curves.springCurve(0, 1, 260, 24)
        }, () => {
          if (i < this.barScales.length) {
            this.barScales[i] = 1
          }
        })
      }, delay)
    }
  }

  private playEntranceAnimation(): void {
    setTimeout(() => {
      animateTo({
        duration: 700,
        curve: curves.springCurve(0, 1, 328, 34)
      }, () => {
        this.headerScale = 1
        this.headerOpacity = 1
      })
    }, 100)

    setTimeout(() => {
      animateTo({
        duration: 700,
        curve: curves.springCurve(0, 1, 300, 30)
      }, () => {
        this.summaryScale = 1
        this.summaryOpacity = 1
      })
    }, 250)

    setTimeout(() => {
      animateTo({
        duration: 800,
        curve: curves.springCurve(0, 1, 280, 28)
      }, () => {
        this.chartScale = 1
        this.chartOpacity = 1
      })
    }, 400)
  }

  build() {
    Column() {
      // å¯¼èˆªæ 
      Row() {
        Button('â†')
          .width(40)
          .height(40)
          .fontSize(20)
          .backgroundColor($r('app.color.bg_surface'))
          .fontColor($r('app.color.text_primary'))
          .borderRadius(20)
          .onClick(() => { router.back() })

        Text('å…³é”®è¯åˆ†æ')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor($r('app.color.text_primary'))
          .margin({ left: 12 })
          .layoutWeight(1)
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 12, bottom: 8 })
      .scale({ x: this.headerScale, y: this.headerScale })
      .opacity(this.headerOpacity)

      Scroll() {
        Column() {
          // åˆ†ææ¦‚è¦
          Column() {
            Text('ğŸ“Š åˆ†ææ¦‚è¦')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor($r('app.color.text_primary'))
              .width('100%')
              .margin({ bottom: 16 })

            Row() {
              Column() {
                Text(`${this.totalNotes}`)
                  .fontSize(28)
                  .fontWeight(FontWeight.Bold)
                  .fontColor($r('app.color.primary_blue'))
                Text('åˆ†æç¬”è®°æ•°')
                  .fontSize(12)
                  .fontColor($r('app.color.text_secondary'))
                  .margin({ top: 4 })
              }
              .layoutWeight(1)

              Column() {
                Text(`${this.keywords.length}`)
                  .fontSize(28)
                  .fontWeight(FontWeight.Bold)
                  .fontColor($r('app.color.primary_green'))
                Text('æå–å…³é”®è¯')
                  .fontSize(12)
                  .fontColor($r('app.color.text_secondary'))
                  .margin({ top: 4 })
              }
              .layoutWeight(1)

              Column() {
                Text(`${this.totalWords}`)
                  .fontSize(28)
                  .fontWeight(FontWeight.Bold)
                  .fontColor($r('app.color.accent_orange'))
                Text('å…³é”®è¯æ€»é¢‘æ¬¡')
                  .fontSize(12)
                  .fontColor($r('app.color.text_secondary'))
                  .margin({ top: 4 })
              }
              .layoutWeight(1)
            }
            .width('100%')

            Text('* åˆ†æèŒƒå›´ï¼šé•¿æœŸè®¡åˆ’ + çŸ­æœŸå¤‡å¿˜ä¸­çš„æ–‡æœ¬å†…å®¹')
              .fontSize(11)
              .fontColor($r('app.color.text_hint'))
              .margin({ top: 12 })
              .width('100%')
          }
          .width('100%')
          .padding(20)
          .margin({ left: 16, right: 16, bottom: 12 })
          .backgroundColor($r('app.color.bg_card'))
          .borderRadius(20)
          .shadow({ radius: 8, color: $r('app.color.shadow_color'), offsetY: 2 })
          .scale({ x: this.summaryScale, y: this.summaryScale })
          .opacity(this.summaryOpacity)

          // å…³é”®è¯çƒ­åº¦è¡¨ - æ¡å½¢å›¾
          Column() {
            Text('ğŸ”¥ å…³é”®è¯çƒ­åº¦è¡¨')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor($r('app.color.text_primary'))
              .width('100%')
              .margin({ bottom: 16 })

            if (this.keywords.length === 0) {
              Column() {
                Text('ğŸ“')
                  .fontSize(48)
                  .margin({ bottom: 12 })
                Text('æš‚æ— è¶³å¤Ÿæ•°æ®è¿›è¡Œåˆ†æ')
                  .fontSize(14)
                  .fontColor($r('app.color.text_hint'))
                Text('æ·»åŠ æ›´å¤šé•¿æœŸè®¡åˆ’æˆ–çŸ­æœŸå¤‡å¿˜åå†æ¥æŸ¥çœ‹')
                  .fontSize(13)
                  .fontColor($r('app.color.text_hint'))
                  .margin({ top: 8 })
              }
              .width('100%')
              .padding({ top: 24, bottom: 24 })
            } else {
              ForEach(this.keywords, (kw: KeywordResult, index: number) => {
                Column() {
                  Row() {
                    // æ’å
                    Text(`${(index !== undefined ? index : 0) + 1}`)
                      .fontSize(12)
                      .fontColor($r('app.color.text_hint'))
                      .width(24)
                      .textAlign(TextAlign.Center)

                    // å…³é”®è¯
                    Text(kw.word)
                      .fontSize(14)
                      .fontColor($r('app.color.text_primary'))
                      .fontWeight(FontWeight.Medium)
                      .width(80)
                      .maxLines(1)
                      .textOverflow({ overflow: TextOverflow.Ellipsis })

                    // æ¡å½¢å›¾
                    Stack({ alignContent: Alignment.Start }) {
                      // èƒŒæ™¯æ¡
                      Row()
                        .width('100%')
                        .height(20)
                        .borderRadius(10)
                        .backgroundColor($r('app.color.bg_surface'))

                      // æ•°æ®æ¡
                      Row()
                        .width(`${(kw.count / this.maxCount * 100)}%`)
                        .height(20)
                        .borderRadius(10)
                        .backgroundColor(
                          (index !== undefined ? index : 0) < 3 ? $r('app.color.primary_green') :
                            (index !== undefined ? index : 0) < 7 ? $r('app.color.primary_blue') :
                            $r('app.color.accent_orange')
                        )
                        .scale({
                          x: index !== undefined && index < this.barScales.length ? this.barScales[index] : 1
                        })
                    }
                    .layoutWeight(1)
                    .margin({ left: 8, right: 8 })

                    // é¢‘æ¬¡
                    Text(`${kw.count}`)
                      .fontSize(13)
                      .fontColor($r('app.color.text_secondary'))
                      .fontWeight(FontWeight.Bold)
                      .width(30)
                      .textAlign(TextAlign.End)
                  }
                  .width('100%')
                  .alignItems(VerticalAlign.Center)
                }
                .width('100%')
                .margin({ bottom: 8 })
              })
            }
          }
          .width('100%')
          .padding(20)
          .margin({ left: 16, right: 16, bottom: 40 })
          .backgroundColor($r('app.color.bg_card'))
          .borderRadius(20)
          .shadow({ radius: 8, color: $r('app.color.shadow_color'), offsetY: 2 })
          .scale({ x: this.chartScale, y: this.chartScale })
          .opacity(this.chartOpacity)
        }
        .width('100%')
      }
      .layoutWeight(1)
      .scrollBar(BarState.Off)
      .edgeEffect(EdgeEffect.Spring)
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('app.color.bg_page'))
  }
}
