/**
 * ç™½å™ªéŸ³/ç¯å¢ƒéŸ³é¡µé¢
 * é›¨å£°ã€å’–å•¡å…ä¸¤ç§å£°éŸ³ï¼Œå¸¦éŸ³é‡æ§åˆ¶å’Œè®¡æ—¶
 */
import router from '@ohos.router'
import curves from '@ohos.curves'

@Entry
@Component
struct WhiteNoisePage {
  @State currentSound: number = -1 // -1æ— , 0é›¨å£°, 1å’–å•¡å…
  @State isPlaying: boolean = false
  @State volume: number = 70
  @State timerSeconds: number = 0
  @State timerRunning: boolean = false

  @State headerScale: number = 0
  @State headerOpacity: number = 0
  @State cardScale: number = 0
  @State cardOpacity: number = 0
  @State waveOffset: number = 0

  private timerId: number = -1

  aboutToAppear(): void {
    this.playEntranceAnimation()
  }

  aboutToDisappear(): void {
    if (this.timerId !== -1) clearInterval(this.timerId)
  }

  private playEntranceAnimation(): void {
    setTimeout(() => {
      animateTo({ duration: 700, curve: curves.springCurve(0, 1, 328, 34) }, () => {
        this.headerScale = 1; this.headerOpacity = 1
      })
    }, 100)
    setTimeout(() => {
      animateTo({ duration: 800, curve: curves.springCurve(0, 1, 300, 28) }, () => {
        this.cardScale = 1; this.cardOpacity = 1
      })
    }, 250)
    // æ³¢æµªåŠ¨ç”»
    setTimeout(() => {
      animateTo({ duration: 3000, curve: Curve.EaseInOut, iterations: -1, playMode: PlayMode.Alternate }, () => {
        this.waveOffset = 10
      })
    }, 500)
  }

  private selectSound(index: number): void {
    if (this.currentSound === index) {
      this.isPlaying = !this.isPlaying
    } else {
      this.currentSound = index
      this.isPlaying = true
    }
    if (this.isPlaying && !this.timerRunning) {
      this.startTimer()
    }
    if (!this.isPlaying) {
      this.stopTimer()
    }
  }

  private startTimer(): void {
    this.timerRunning = true
    this.timerSeconds = 0
    this.timerId = setInterval(() => {
      this.timerSeconds++
    }, 1000)
  }

  private stopTimer(): void {
    this.timerRunning = false
    if (this.timerId !== -1) { clearInterval(this.timerId); this.timerId = -1 }
  }

  private formatTime(seconds: number): string {
    let m = Math.floor(seconds / 60).toString().padStart(2, '0')
    let s = (seconds % 60).toString().padStart(2, '0')
    return `${m}:${s}`
  }

  build() {
    Column() {
      Row() {
        Button('â†').width(40).height(40).fontSize(20)
          .backgroundColor($r('app.color.bg_surface')).fontColor($r('app.color.text_primary'))
          .borderRadius(20).onClick(() => { this.stopTimer(); router.back() })
        Text('ç™½å™ªéŸ³').fontSize(20).fontWeight(FontWeight.Bold)
          .fontColor($r('app.color.text_primary')).margin({ left: 12 }).layoutWeight(1)
      }
      .width('100%').padding({ left: 16, right: 16, top: 12, bottom: 8 })
      .scale({ x: this.headerScale, y: this.headerScale }).opacity(this.headerOpacity)

      Scroll() {
        Column() {
          // æ’­æ”¾çŠ¶æ€è§†è§‰
          Column() {
            if (this.isPlaying) {
              // æ³¢å½¢åŠ¨ç”»
              Row() {
                ForEach([16, 24, 32, 20, 28, 36, 22, 30, 18, 26], (h: number, i: number) => {
                  Row()
                    .width(4).height(h + (i !== undefined && i % 2 === 0 ? this.waveOffset : -this.waveOffset))
                    .borderRadius(2)
                    .backgroundColor(this.currentSound === 0 ? '#42A5F5' : '#8D6E63')
                    .margin({ left: 3, right: 3 })
                    .opacity(0.7)
                })
              }
              .margin({ bottom: 16 })

              Text(this.currentSound === 0 ? 'ğŸŒ§ é›¨å£°æ’­æ”¾ä¸­...' : 'â˜• å’–å•¡å…éŸ³æ’­æ”¾ä¸­...')
                .fontSize(18).fontColor($r('app.color.text_primary')).fontWeight(FontWeight.Bold)

              Text(this.formatTime(this.timerSeconds))
                .fontSize(40).fontWeight(FontWeight.Bold)
                .fontColor($r('app.color.primary_blue')).margin({ top: 8 })
            } else {
              Text('ğŸµ').fontSize(60).margin({ bottom: 8 })
              Text('é€‰æ‹©ä¸€ç§ç¯å¢ƒéŸ³å¼€å§‹æ”¾æ¾')
                .fontSize(16).fontColor($r('app.color.text_secondary'))
            }
          }
          .width('100%').padding({ top: 40, bottom: 40 })
          .alignItems(HorizontalAlign.Center)

          // å£°éŸ³é€‰æ‹©å¡ç‰‡
          Row() {
            // é›¨å£°
            Column() {
              Text('ğŸŒ§').fontSize(40).margin({ bottom: 8 })
              Text('é›¨å£°').fontSize(16).fontWeight(FontWeight.Bold).fontColor($r('app.color.text_primary'))
              Text('é™è°§é›¨å¤œ').fontSize(12).fontColor($r('app.color.text_secondary')).margin({ top: 4 })

              if (this.currentSound === 0 && this.isPlaying) {
                Text('æ’­æ”¾ä¸­').fontSize(11).fontColor('#42A5F5')
                  .fontWeight(FontWeight.Bold).margin({ top: 8 })
              }
            }
            .layoutWeight(1)
            .padding(24)
            .backgroundColor(this.currentSound === 0 && this.isPlaying ? '#E3F2FD' : $r('app.color.bg_card'))
            .borderRadius(20)
            .alignItems(HorizontalAlign.Center)
            .border({ width: this.currentSound === 0 && this.isPlaying ? 2 : 0, color: '#42A5F5' })
            .shadow({ radius: 6, color: $r('app.color.shadow_color'), offsetY: 2 })
            .onClick(() => { this.selectSound(0) })

            Column().width(12)

            // å’–å•¡å…
            Column() {
              Text('â˜•').fontSize(40).margin({ bottom: 8 })
              Text('å’–å•¡å…').fontSize(16).fontWeight(FontWeight.Bold).fontColor($r('app.color.text_primary'))
              Text('èˆ’é€‚å˜ˆæ‚').fontSize(12).fontColor($r('app.color.text_secondary')).margin({ top: 4 })

              if (this.currentSound === 1 && this.isPlaying) {
                Text('æ’­æ”¾ä¸­').fontSize(11).fontColor('#8D6E63')
                  .fontWeight(FontWeight.Bold).margin({ top: 8 })
              }
            }
            .layoutWeight(1)
            .padding(24)
            .backgroundColor(this.currentSound === 1 && this.isPlaying ? '#EFEBE9' : $r('app.color.bg_card'))
            .borderRadius(20)
            .alignItems(HorizontalAlign.Center)
            .border({ width: this.currentSound === 1 && this.isPlaying ? 2 : 0, color: '#8D6E63' })
            .shadow({ radius: 6, color: $r('app.color.shadow_color'), offsetY: 2 })
            .onClick(() => { this.selectSound(1) })
          }
          .width('100%').padding({ left: 16, right: 16 })

          // éŸ³é‡æ§åˆ¶
          Column() {
            Row() {
              Text('ğŸ”Š éŸ³é‡').fontSize(14).fontColor($r('app.color.text_secondary'))
              Blank()
              Text(`${this.volume}%`).fontSize(14).fontColor($r('app.color.text_primary')).fontWeight(FontWeight.Bold)
            }.width('100%').margin({ bottom: 8 })

            Slider({ value: this.volume, min: 0, max: 100, step: 5 })
              .blockColor($r('app.color.primary_blue'))
              .trackColor($r('app.color.progress_track'))
              .selectedColor($r('app.color.primary_blue'))
              .onChange((value: number) => { this.volume = value })
          }
          .width('100%').padding(20)
          .margin({ left: 16, right: 16, top: 16 })
          .backgroundColor($r('app.color.bg_card')).borderRadius(20)
          .shadow({ radius: 6, color: $r('app.color.shadow_color'), offsetY: 2 })

          // åœæ­¢æŒ‰é’®
          if (this.isPlaying) {
            Button('åœæ­¢æ’­æ”¾').width('60%').height(48).fontSize(16).fontWeight(FontWeight.Bold)
              .fontColor(Color.White).backgroundColor($r('app.color.error_red')).borderRadius(24)
              .margin({ top: 24 })
              .onClick(() => { this.isPlaying = false; this.stopTimer() })
          }

          // æç¤º
          Text('æç¤ºï¼šç™½å™ªéŸ³ä¸ºè§†è§‰æ¨¡æ‹Ÿï¼Œå®é™…éŸ³é¢‘éœ€é…åˆç³»ç»Ÿåª’ä½“æ’­æ”¾')
            .fontSize(11).fontColor($r('app.color.text_hint'))
            .margin({ top: 20, bottom: 40 }).textAlign(TextAlign.Center)
        }.width('100%')
      }
      .layoutWeight(1).scrollBar(BarState.Off).edgeEffect(EdgeEffect.Spring).align(Alignment.Top)
    }
    .width('100%').height('100%').backgroundColor($r('app.color.bg_page'))
  }
}
