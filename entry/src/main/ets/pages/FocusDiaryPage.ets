/**
 * ä¸“æ³¨æ—¥è®°é¡µé¢
 * è®°å½•ä»Šå¤©å®Œæˆäº†ä»€ä¹ˆï¼Œç®€çŸ­å¤ç›˜
 */
import router from '@ohos.router'
import curves from '@ohos.curves'
import { PreferencesUtil } from '../utils/PreferencesUtil'
import { FocusNote } from '../model/DataModels'

@Entry
@Component
struct FocusDiaryPage {
  @State diaryContent: string = ''
  @State mood: string = ''
  @State saved: boolean = false
  @State headerScale: number = 0
  @State headerOpacity: number = 0
  @State bodyScale: number = 0
  @State bodyOpacity: number = 0

  private moods: string[] = ['ðŸ˜Š å¼€å¿ƒ', 'ðŸ˜Œ å¹³é™', 'ðŸ’ª å……å®ž', 'ðŸ˜« ç–²æƒ«', 'ðŸ˜¤ ç„¦è™‘', 'ðŸ¤” ä¸€èˆ¬']

  aboutToAppear(): void {
    setTimeout(() => {
      animateTo({ duration: 700, curve: curves.springCurve(0, 1, 328, 34) }, () => {
        this.headerScale = 1; this.headerOpacity = 1
      })
    }, 100)
    setTimeout(() => {
      animateTo({ duration: 800, curve: curves.springCurve(0, 1, 300, 28) }, () => {
        this.bodyScale = 1; this.bodyOpacity = 1
      })
    }, 250)
  }

  private async saveDiary(): Promise<void> {
    if (this.diaryContent.trim() === '') return
    let today = PreferencesUtil.getDateStr(new Date())
    let diary: FocusNote = {
      id: PreferencesUtil.generateId(),
      type: 'longterm',
      title: `ðŸ“– ä¸“æ³¨æ—¥è®° ${today}`,
      content: `${this.mood !== '' ? 'å¿ƒæƒ…: ' + this.mood + '\n\n' : ''}${this.diaryContent}`,
      targetDate: 0,
      status: 'completed',
      url: '',
      createdAt: Date.now(),
      updatedAt: Date.now()
    }
    await PreferencesUtil.saveNote(diary)
    this.saved = true
  }

  build() {
    Column() {
      Row() {
        Button('â†').width(40).height(40).fontSize(20)
          .backgroundColor($r('app.color.bg_surface')).fontColor($r('app.color.text_primary'))
          .borderRadius(20).onClick(() => { router.back() })
        Text('ä¸“æ³¨æ—¥è®°').fontSize(20).fontWeight(FontWeight.Bold)
          .fontColor($r('app.color.text_primary')).margin({ left: 12 }).layoutWeight(1)
      }.width('100%').padding({ left: 16, right: 16, top: 12, bottom: 8 })
        .scale({ x: this.headerScale, y: this.headerScale }).opacity(this.headerOpacity)

      Scroll() {
        Column() {
          if (this.saved) {
            Column() {
              Text('ðŸ“–').fontSize(60).margin({ bottom: 16 })
              Text('æ—¥è®°å·²ä¿å­˜ï¼').fontSize(20).fontWeight(FontWeight.Bold).fontColor($r('app.color.primary_green'))
              Text('å¯ä»¥åœ¨ã€Œç¬”è®° > é•¿æœŸè®¡åˆ’ã€ä¸­æŸ¥çœ‹').fontSize(13).fontColor($r('app.color.text_secondary')).margin({ top: 8 })
              Button('è¿”å›ž').width('50%').height(44).fontSize(16)
                .fontColor(Color.White).backgroundColor($r('app.color.primary_green')).borderRadius(22)
                .margin({ top: 24 }).onClick(() => { router.back() })
            }.width('100%').padding({ top: 60 }).alignItems(HorizontalAlign.Center)
          } else {
            // æ—¥æœŸ
            Text(`ðŸ“… ${PreferencesUtil.getDateStr(new Date())}`)
              .fontSize(16).fontColor($r('app.color.primary_blue')).fontWeight(FontWeight.Bold)
              .width('100%').padding({ left: 20 }).margin({ bottom: 12 })

            // å¿ƒæƒ…é€‰æ‹©
            Column() {
              Text('ä»Šå¤©çš„å¿ƒæƒ…').fontSize(16).fontWeight(FontWeight.Bold)
                .fontColor($r('app.color.text_primary')).width('100%').margin({ bottom: 12 })
              Flex({ wrap: FlexWrap.Wrap }) {
                ForEach(this.moods, (m: string) => {
                  Text(m).fontSize(13)
                    .fontColor(this.mood === m ? $r('app.color.primary_green') : $r('app.color.text_secondary'))
                    .backgroundColor(this.mood === m ? $r('app.color.primary_green_light') : $r('app.color.bg_surface'))
                    .padding({ left: 12, right: 12, top: 8, bottom: 8 })
                    .borderRadius(16).margin({ right: 8, bottom: 8 })
                    .onClick(() => { this.mood = this.mood === m ? '' : m })
                })
              }
            }.width('100%').padding(20).margin({ left: 16, right: 16, bottom: 12 })
              .backgroundColor($r('app.color.bg_card')).borderRadius(20)
              .shadow({ radius: 6, color: $r('app.color.shadow_color'), offsetY: 2 })

            // æ—¥è®°å†…å®¹
            Column() {
              Text('ä»Šæ—¥å¤ç›˜').fontSize(16).fontWeight(FontWeight.Bold)
                .fontColor($r('app.color.text_primary')).width('100%').margin({ bottom: 8 })
              TextArea({ placeholder: 'ä»Šå¤©å®Œæˆäº†ä»€ä¹ˆï¼Ÿæœ‰ä»€ä¹ˆæ”¶èŽ·æˆ–æ„Ÿæ‚Ÿï¼Ÿ\n\nä¾‹å¦‚ï¼š\n- å®Œæˆäº†XXçš„å­¦ä¹ \n- ä¸“æ³¨åŠ›æ¯”æ˜¨å¤©å¥½\n- æ˜Žå¤©è¦ç»§ç»­...' })
                .width('100%').height(200).fontSize(14)
                .backgroundColor($r('app.color.bg_surface')).borderRadius(12)
                .onChange((v: string) => { this.diaryContent = v })
            }.width('100%').padding(20).margin({ left: 16, right: 16, bottom: 16 })
              .backgroundColor($r('app.color.bg_card')).borderRadius(20)
              .shadow({ radius: 6, color: $r('app.color.shadow_color'), offsetY: 2 })

            Button('ä¿å­˜æ—¥è®°').width('80%').height(48).fontSize(16).fontWeight(FontWeight.Bold)
              .fontColor(Color.White).backgroundColor($r('app.color.primary_green')).borderRadius(24)
              .margin({ bottom: 40 })
              .onClick(() => { this.saveDiary() })
          }
        }.width('100%').padding({ top: 8 })
      }.layoutWeight(1).scrollBar(BarState.Off).edgeEffect(EdgeEffect.Spring).align(Alignment.Top)
        .scale({ x: this.bodyScale, y: this.bodyScale }).opacity(this.bodyOpacity)
    }.width('100%').height('100%').backgroundColor($r('app.color.bg_page'))
  }
}
