/**
 * æˆ’æ–­æ‰‹æœºé¡µé¢
 * ç”¨æˆ·ä¿æŒåœ¨æ­¤é¡µé¢è®¡æ—¶ï¼Œç¦»å¼€é¡µé¢æ—¶æ˜¾ç¤ºæˆ’æ–­æ—¶é•¿
 */
import router from '@ohos.router'
import curves from '@ohos.curves'

@Entry
@Component
struct PhoneDetoxPage {
  @State isActive: boolean = false
  @State elapsedSeconds: number = 0
  @State showResult: boolean = false
  @State resultSeconds: number = 0

  @State headerScale: number = 0
  @State headerOpacity: number = 0
  @State bodyScale: number = 0
  @State bodyOpacity: number = 0
  @State pulseScale: number = 1
  @State breatheOpacity: number = 0.3

  private timerId: number = -1

  aboutToAppear(): void {
    setTimeout(() => {
      animateTo({ duration: 700, curve: curves.springCurve(0, 1, 328, 34) }, () => {
        this.headerScale = 1; this.headerOpacity = 1
      })
    }, 100)
    setTimeout(() => {
      animateTo({ duration: 800, curve: curves.springCurve(0, 1, 300, 28) }, () => {
        this.bodyScale = 1; this.bodyOpacity = 1
      })
    }, 250)
  }

  aboutToDisappear(): void {
    if (this.isActive) {
      this.endDetox()
    }
    if (this.timerId !== -1) clearInterval(this.timerId)
  }

  private startDetox(): void {
    this.isActive = true
    this.elapsedSeconds = 0
    this.showResult = false
    this.timerId = setInterval(() => {
      this.elapsedSeconds++
    }, 1000)

    // å‘¼å¸è„‰å†²åŠ¨ç”»
    animateTo({
      duration: 2000, curve: Curve.EaseInOut, iterations: -1, playMode: PlayMode.Alternate
    }, () => {
      this.pulseScale = 1.1
      this.breatheOpacity = 0.6
    })
  }

  private endDetox(): void {
    if (this.timerId !== -1) { clearInterval(this.timerId); this.timerId = -1 }
    this.resultSeconds = this.elapsedSeconds
    this.isActive = false
    this.showResult = true
    this.pulseScale = 1
    this.breatheOpacity = 0.3
  }

  private formatTime(seconds: number): string {
    let h = Math.floor(seconds / 3600)
    let m = Math.floor((seconds % 3600) / 60)
    let s = seconds % 60
    let ms = m.toString().padStart(2, '0')
    let ss = s.toString().padStart(2, '0')
    if (h > 0) {
      return `${h}:${ms}:${ss}`
    }
    return `${ms}:${ss}`
  }

  private getEncouragement(): string {
    if (this.resultSeconds >= 3600) return 'ðŸ† å¤ªåŽ‰å®³äº†ï¼è¶…è¿‡ä¸€å°æ—¶çš„è‡ªæŽ§åŠ›ï¼'
    if (this.resultSeconds >= 1800) return 'ðŸŒŸ åŠå°æ—¶ä»¥ä¸Šï¼Œä½ çš„æ„å¿—åŠ›å¾ˆå¼ºï¼'
    if (this.resultSeconds >= 600) return 'ðŸ’ª ååˆ†é’Ÿå¾ˆæ£’äº†ï¼Œç»§ç»­åŠ æ²¹ï¼'
    if (this.resultSeconds >= 120) return 'ðŸ‘ ä¸é”™çš„å¼€å§‹ï¼Œä¸‹æ¬¡æ›´ä¹…ä¸€ç‚¹ï¼'
    return 'ðŸŒ± æ¯ä¸€æ¬¡å°è¯•éƒ½æ˜¯è¿›æ­¥ï¼'
  }

  build() {
    Column() {
      // é¡¶æ ï¼šåªåœ¨éžæ´»è·ƒæ—¶æ˜¾ç¤ºè¿”å›žæŒ‰é’®
      Row() {
        if (!this.isActive) {
          Button('â†').width(40).height(40).fontSize(20)
            .backgroundColor($r('app.color.bg_surface')).fontColor($r('app.color.text_primary'))
            .borderRadius(20).onClick(() => { router.back() })
        }
        Text('æˆ’æ–­æ‰‹æœº').fontSize(20).fontWeight(FontWeight.Bold)
          .fontColor($r('app.color.text_primary')).margin({ left: this.isActive ? 0 : 12 }).layoutWeight(1)
          .textAlign(this.isActive ? TextAlign.Center : TextAlign.Start)
      }.width('100%').padding({ left: 16, right: 16, top: 12, bottom: 8 })
        .scale({ x: this.headerScale, y: this.headerScale }).opacity(this.headerOpacity)

      Column() {
        if (this.showResult) {
          // ===== ç»“æžœé¡µ =====
          Text('ðŸŽ‰').fontSize(60).margin({ bottom: 16 })
          Text('æ­å–œä½ å®Œæˆæˆ’æ–­ï¼').fontSize(24).fontWeight(FontWeight.Bold)
            .fontColor($r('app.color.primary_green'))

          Text(this.formatTime(this.resultSeconds))
            .fontSize(56).fontWeight(FontWeight.Bold)
            .fontColor($r('app.color.primary_blue')).margin({ top: 16, bottom: 8 })

          Text(this.getEncouragement())
            .fontSize(15).fontColor($r('app.color.text_secondary')).margin({ bottom: 32 })
            .textAlign(TextAlign.Center).padding({ left: 20, right: 20 })

          Button('å†æ¥ä¸€æ¬¡').width('60%').height(48).fontSize(16).fontWeight(FontWeight.Bold)
            .fontColor(Color.White).backgroundColor($r('app.color.primary_green')).borderRadius(24)
            .onClick(() => { this.showResult = false })

          Button('è¿”å›ž').width('60%').height(40).fontSize(14)
            .fontColor($r('app.color.text_secondary')).backgroundColor($r('app.color.bg_surface'))
            .borderRadius(20).margin({ top: 12 })
            .onClick(() => { router.back() })

        } else if (this.isActive) {
          // ===== è®¡æ—¶ä¸­ =====
          Text('ðŸ“µ').fontSize(60).margin({ bottom: 12 })

          Text('ä¿æŒåœ¨è¿™ä¸ªé¡µé¢').fontSize(16).fontColor($r('app.color.text_secondary'))

          // å¤§è®¡æ—¶å™¨
          Stack() {
            Circle().width(220).height(220)
              .fill($r('app.color.primary_green'))
              .opacity(this.breatheOpacity * 0.3)
              .scale({ x: this.pulseScale, y: this.pulseScale })

            Circle().width(180).height(180)
              .fill($r('app.color.primary_green'))
              .opacity(this.breatheOpacity * 0.5)
              .scale({ x: this.pulseScale, y: this.pulseScale })

            Column() {
              Text(this.formatTime(this.elapsedSeconds))
                .fontSize(48).fontWeight(FontWeight.Bold).fontColor($r('app.color.text_primary'))
              Text('å·²æˆ’æ–­').fontSize(14).fontColor($r('app.color.text_secondary')).margin({ top: 4 })
            }
          }
          .margin({ top: 32, bottom: 32 })

          Text('ç¦»å¼€æ­¤é¡µé¢æˆ–ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ç»“æŸè®¡æ—¶')
            .fontSize(12).fontColor($r('app.color.text_hint')).margin({ bottom: 24 })

          Button('ç»“æŸæˆ’æ–­').width('60%').height(48).fontSize(16).fontWeight(FontWeight.Bold)
            .fontColor(Color.White).backgroundColor($r('app.color.accent_orange')).borderRadius(24)
            .onClick(() => { this.endDetox() })

        } else {
          // ===== æœªå¼€å§‹ =====
          Text('ðŸ“µ').fontSize(70).margin({ bottom: 16 })
          Text('æˆ’æ–­æ‰‹æœºæŒ‘æˆ˜').fontSize(24).fontWeight(FontWeight.Bold)
            .fontColor($r('app.color.text_primary')).margin({ bottom: 8 })
          Text('å¼€å§‹åŽè¯·ä¿æŒåœ¨æ­¤é¡µé¢\nä¸è¦åˆ‡æ¢åˆ°å…¶ä»–åº”ç”¨\nç¦»å¼€å³ç»“æŸè®¡æ—¶')
            .fontSize(14).fontColor($r('app.color.text_secondary'))
            .textAlign(TextAlign.Center).lineHeight(22).margin({ bottom: 40 })

          Button('å¼€å§‹æˆ’æ–­').width('70%').height(56).fontSize(20).fontWeight(FontWeight.Bold)
            .fontColor(Color.White).backgroundColor($r('app.color.primary_green')).borderRadius(28)
            .shadow({ radius: 10, color: $r('app.color.shadow_color'), offsetY: 4 })
            .onClick(() => { this.startDetox() })
        }
      }
      .layoutWeight(1).justifyContent(FlexAlign.Center).alignItems(HorizontalAlign.Center)
      .scale({ x: this.bodyScale, y: this.bodyScale }).opacity(this.bodyOpacity)
    }
    .width('100%').height('100%').backgroundColor($r('app.color.bg_page'))
  }
}
