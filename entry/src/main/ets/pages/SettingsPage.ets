/**
 * è®¾ç½®é¡µé¢ï¼ˆäºŒçº§é¡µé¢ï¼‰
 * ä¸ä½¿ç”¨è‡ªå®šä¹‰ç»„ä»¶ï¼Œæ‰€æœ‰ UI åœ¨ ArkUI ä¸­ç›´æ¥æ„å»º
 * åŒ…å«åº”ç”¨ä¿¡æ¯ã€ç‰ˆæœ¬ã€å…³äºç­‰
 */
import router from '@ohos.router'
import curves from '@ohos.curves'
import { PreferencesUtil } from '../utils/PreferencesUtil'
import { UserGrowth } from '../model/DataModels'

@Entry
@Component
struct SettingsPage {
  @State growth: UserGrowth = {
    totalPoints: 0,
    treeStage: 0,
    totalFocusMinutes: 0,
    currentStreak: 0,
    longestStreak: 0,
    lastActiveDate: ''
  }

  // åŠ¨ç”»çŠ¶æ€
  @State headerScale: number = 0
  @State headerOpacity: number = 0
  @State aboutScale: number = 0
  @State aboutOpacity: number = 0
  @State statsScale: number = 0
  @State statsOpacity: number = 0
  @State infoScale: number = 0
  @State infoOpacity: number = 0

  aboutToAppear(): void {
    this.loadData()
    this.playEntranceAnimation()
  }

  private async loadData(): Promise<void> {
    this.growth = await PreferencesUtil.getUserGrowth()
  }

  private playEntranceAnimation(): void {
    setTimeout(() => {
      animateTo({
        duration: 700,
        curve: curves.springCurve(0, 1, 328, 34)
      }, () => {
        this.headerScale = 1
        this.headerOpacity = 1
      })
    }, 100)

    setTimeout(() => {
      animateTo({
        duration: 800,
        curve: curves.springCurve(0, 1, 300, 28)
      }, () => {
        this.aboutScale = 1
        this.aboutOpacity = 1
      })
    }, 250)

    setTimeout(() => {
      animateTo({
        duration: 700,
        curve: curves.springCurve(0, 1, 280, 26)
      }, () => {
        this.statsScale = 1
        this.statsOpacity = 1
      })
    }, 400)

    setTimeout(() => {
      animateTo({
        duration: 600,
        curve: curves.springCurve(0, 1, 260, 24)
      }, () => {
        this.infoScale = 1
        this.infoOpacity = 1
      })
    }, 550)
  }

  @Builder
  buildSettingRow(title: string, value: string) {
    Row() {
      Text(title)
        .fontSize(15)
        .fontColor($r('app.color.text_primary'))
        .layoutWeight(1)
      Text(value)
        .fontSize(14)
        .fontColor($r('app.color.text_secondary'))
    }
    .width('100%')
    .padding({ top: 14, bottom: 14 })
    .border({
      width: { bottom: 0.5 },
      color: $r('app.color.divider')
    })
  }

  build() {
    Column() {
      // å¯¼èˆªæ 
      Row() {
        Button('â†')
          .width(40)
          .height(40)
          .fontSize(20)
          .backgroundColor($r('app.color.bg_surface'))
          .fontColor($r('app.color.text_primary'))
          .borderRadius(20)
          .onClick(() => { router.back() })

        Text('è®¾ç½®')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor($r('app.color.text_primary'))
          .margin({ left: 12 })
          .layoutWeight(1)
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 12, bottom: 8 })
      .scale({ x: this.headerScale, y: this.headerScale })
      .opacity(this.headerOpacity)

      Scroll() {
        Column() {
          // åº”ç”¨ä»‹ç»
          Column() {
            // LogoåŒºåŸŸ
            Stack() {
              Circle()
                .width(80)
                .height(80)
                .fill($r('app.color.primary_green_light'))

              Text('ğŸŒ¿')
                .fontSize(40)
            }
            .margin({ bottom: 16 })

            Text('FocusZone')
              .fontSize(28)
              .fontWeight(FontWeight.Bold)
              .fontColor($r('app.color.primary_green'))

            Text('ä¸“æ³¨åŠ›ç®¡ç†ä¸æ¿€åŠ±å·¥å…·')
              .fontSize(14)
              .fontColor($r('app.color.text_secondary'))
              .margin({ top: 6, bottom: 12 })

            Text('é›†ç•ªèŒ„æ—¶é’Ÿã€ä¹ æƒ¯è¿½è¸ªã€è¿›åº¦å¯è§†åŒ–ã€æ¸¸æˆåŒ–æ¿€åŠ±å’Œè½»é‡ç¬”è®°äºä¸€ä½“çš„ç»¼åˆæ€§ä¸“æ³¨åŠ›è¾…åŠ©å·¥å…·ã€‚å¸®åŠ©ä½ å»ºç«‹ä¸“æ³¨ä¹ æƒ¯ï¼ŒåŸ¹è‚²å±äºä½ çš„ç”Ÿå‘½ä¹‹æ ‘ã€‚')
              .fontSize(13)
              .fontColor($r('app.color.text_secondary'))
              .textAlign(TextAlign.Center)
              .lineHeight(20)
              .padding({ left: 16, right: 16 })
          }
          .width('100%')
          .padding(24)
          .margin({ left: 16, right: 16, bottom: 12 })
          .backgroundColor($r('app.color.bg_card'))
          .borderRadius(20)
          .alignItems(HorizontalAlign.Center)
          .shadow({ radius: 8, color: $r('app.color.shadow_color'), offsetY: 2 })
          .scale({ x: this.aboutScale, y: this.aboutScale })
          .opacity(this.aboutOpacity)

          // æˆ‘çš„æ•°æ®
          Column() {
            Text('æˆ‘çš„æ•°æ®')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor($r('app.color.text_primary'))
              .width('100%')
              .margin({ bottom: 8 })

            this.buildSettingRow('æ€»ç§¯åˆ†', `${this.growth.totalPoints} åˆ†`)
            this.buildSettingRow('æ€»ä¸“æ³¨æ—¶é•¿',
              PreferencesUtil.formatDuration(this.growth.totalFocusMinutes))
            this.buildSettingRow('å½“å‰è¿ç»­æ‰“å¡', `${this.growth.currentStreak} å¤©`)
            this.buildSettingRow('æœ€é•¿è¿ç»­æ‰“å¡', `${this.growth.longestStreak} å¤©`)
            this.buildSettingRow('ç”Ÿå‘½ä¹‹æ ‘é˜¶æ®µ',
              `${ ['ç§å­', 'å«©èŠ½', 'å°æ ‘', 'èŒ‚ç››æ ‘', 'å¼€èŠ±æ ‘', 'å‚å¤©å¤§æ ‘'][this.growth.treeStage]}`)
            this.buildSettingRow('ä¸Šæ¬¡æ´»è·ƒ',
              this.growth.lastActiveDate !== '' ? this.growth.lastActiveDate : 'æš‚æ— è®°å½•')
          }
          .width('100%')
          .padding(20)
          .margin({ left: 16, right: 16, bottom: 12 })
          .backgroundColor($r('app.color.bg_card'))
          .borderRadius(20)
          .shadow({ radius: 8, color: $r('app.color.shadow_color'), offsetY: 2 })
          .scale({ x: this.statsScale, y: this.statsScale })
          .opacity(this.statsOpacity)

          // åº”ç”¨ä¿¡æ¯
          Column() {
            Text('åº”ç”¨ä¿¡æ¯')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor($r('app.color.text_primary'))
              .width('100%')
              .margin({ bottom: 8 })

            this.buildSettingRow('åº”ç”¨åç§°', 'FocusZone')
            this.buildSettingRow('ç‰ˆæœ¬å·', '1.0.0')
            this.buildSettingRow('ç›®æ ‡å¹³å°', 'HarmonyOS 6.0.2')
            this.buildSettingRow('SDKç‰ˆæœ¬', 'API 12+')
            this.buildSettingRow('å¼€å‘æ¡†æ¶', 'ArkTS / ArkUI')
            this.buildSettingRow('æ•°æ®å­˜å‚¨', 'æœ¬åœ°å­˜å‚¨ (Preferences)')

            Row() {
              Text('éšç§è¯´æ˜')
                .fontSize(15)
                .fontColor($r('app.color.text_primary'))
                .layoutWeight(1)
              Text('æ‰€æœ‰æ•°æ®ä»…å­˜å‚¨åœ¨æœ¬åœ°ï¼Œä¿æŠ¤æ‚¨çš„éšç§')
                .fontSize(12)
                .fontColor($r('app.color.success_green'))
            }
            .width('100%')
            .padding({ top: 14, bottom: 14 })
          }
          .width('100%')
          .padding(20)
          .margin({ left: 16, right: 16, bottom: 12 })
          .backgroundColor($r('app.color.bg_card'))
          .borderRadius(20)
          .shadow({ radius: 8, color: $r('app.color.shadow_color'), offsetY: 2 })
          .scale({ x: this.infoScale, y: this.infoScale })
          .opacity(this.infoOpacity)

          // åŠŸèƒ½ç‰¹è‰²
          Column() {
            Text('âœ¨ åŠŸèƒ½ç‰¹è‰²')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor($r('app.color.text_primary'))
              .width('100%')
              .margin({ bottom: 12 })

            Column() {
              this.buildFeatureItem('â±', 'ä¸“æ³¨è®¡æ—¶', 'é¢„è®¾/æ‰‹åŠ¨åŒæ¨¡å¼è®¡æ—¶ï¼Œç•ªèŒ„é’Ÿå·¥ä½œæ³•')
              this.buildFeatureItem('ğŸ“‹', 'è®¡åˆ’ç®¡ç†', 'åˆ›å»ºé¡¹ç›®ï¼Œè®¾å®šç›®æ ‡ï¼Œè¿½è¸ªè¿›åº¦')
              this.buildFeatureItem('ğŸ“…', 'ä¸“æ³¨æ—¥å†', 'æœˆå†å±•ç¤ºä¸“æ³¨è®°å½•ï¼Œå¯è§†åŒ–çƒ­åŠ›å›¾')
              this.buildFeatureItem('ğŸŒ³', 'æˆé•¿ç³»ç»Ÿ', 'ç§¯åˆ†æ¿€åŠ±ï¼Œç”Ÿå‘½ä¹‹æ ‘å…­é˜¶æ®µæˆé•¿')
              this.buildFeatureItem('ğŸ“', 'æ™ºèƒ½ç¬”è®°', 'é•¿æœŸè®¡åˆ’/çŸ­æœŸå¤‡å¿˜/ä¸ªäººæ”¶è—')
              this.buildFeatureItem('ğŸ“Š', 'å…³é”®è¯åˆ†æ', 'è‡ªåŠ¨åˆ†æç¬”è®°å†…å®¹ï¼Œæå–å…³é”®è¯çƒ­åº¦')
            }
          }
          .width('100%')
          .padding(20)
          .margin({ left: 16, right: 16, bottom: 40 })
          .backgroundColor($r('app.color.bg_card'))
          .borderRadius(20)
          .shadow({ radius: 8, color: $r('app.color.shadow_color'), offsetY: 2 })
          .scale({ x: this.infoScale, y: this.infoScale })
          .opacity(this.infoOpacity)
        }
        .width('100%')
      }
      .layoutWeight(1)
      .scrollBar(BarState.Off)
      .edgeEffect(EdgeEffect.Spring)
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('app.color.bg_page'))
  }

  @Builder
  buildFeatureItem(icon: string, title: string, desc: string) {
    Row() {
      Text(icon)
        .fontSize(24)
        .width(40)
        .textAlign(TextAlign.Center)

      Column() {
        Text(title)
          .fontSize(15)
          .fontWeight(FontWeight.Bold)
          .fontColor($r('app.color.text_primary'))
        Text(desc)
          .fontSize(12)
          .fontColor($r('app.color.text_secondary'))
          .margin({ top: 2 })
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)
      .margin({ left: 8 })
    }
    .width('100%')
    .padding({ top: 8, bottom: 8 })
  }
}
