/**
 * å‘¼å¸ç»ƒä¹ é¡µé¢
 * 1-3åˆ†é’Ÿå¼•å¯¼å‘¼å¸ï¼šå¸æ°”-å±æ°”-å‘¼æ°” å¾ªçŽ¯
 */
import router from '@ohos.router'
import curves from '@ohos.curves'

@Entry
@Component
struct BreathingPage {
  @State selectedDuration: number = 1 // 1,2,3åˆ†é’Ÿ
  @State isRunning: boolean = false
  @State phase: string = 'å‡†å¤‡' // å‡†å¤‡/å¸æ°”/å±æ°”/å‘¼æ°”/å®Œæˆ
  @State phaseSeconds: number = 0
  @State totalSeconds: number = 0
  @State circleScale: number = 0.5
  @State circleOpacity: number = 0.3
  @State cycleCount: number = 0

  @State headerScale: number = 0
  @State headerOpacity: number = 0
  @State bodyScale: number = 0
  @State bodyOpacity: number = 0

  private timerId: number = -1
  // å¸æ°”4ç§’-å±æ°”4ç§’-å‘¼æ°”6ç§’=14ç§’ä¸€å¾ªçŽ¯
  private inhaleTime: number = 4
  private holdTime: number = 4
  private exhaleTime: number = 6

  aboutToAppear(): void {
    setTimeout(() => {
      animateTo({ duration: 700, curve: curves.springCurve(0, 1, 328, 34) }, () => {
        this.headerScale = 1; this.headerOpacity = 1
      })
    }, 100)
    setTimeout(() => {
      animateTo({ duration: 800, curve: curves.springCurve(0, 1, 300, 28) }, () => {
        this.bodyScale = 1; this.bodyOpacity = 1
      })
    }, 250)
  }

  aboutToDisappear(): void {
    if (this.timerId !== -1) clearInterval(this.timerId)
  }

  private startBreathing(): void {
    this.isRunning = true
    this.totalSeconds = 0
    this.phase = 'å¸æ°”'
    this.phaseSeconds = 0
    this.cycleCount = 0
    this.animateInhale()

    this.timerId = setInterval(() => {
      this.totalSeconds++
      this.phaseSeconds++

      if (this.phase === 'å¸æ°”' && this.phaseSeconds >= this.inhaleTime) {
        this.phase = 'å±æ°”'
        this.phaseSeconds = 0
        this.animateHold()
      } else if (this.phase === 'å±æ°”' && this.phaseSeconds >= this.holdTime) {
        this.phase = 'å‘¼æ°”'
        this.phaseSeconds = 0
        this.animateExhale()
      } else if (this.phase === 'å‘¼æ°”' && this.phaseSeconds >= this.exhaleTime) {
        this.cycleCount++
        if (this.totalSeconds >= this.selectedDuration * 60) {
          this.finish()
          return
        }
        this.phase = 'å¸æ°”'
        this.phaseSeconds = 0
        this.animateInhale()
      }
    }, 1000)
  }

  private animateInhale(): void {
    animateTo({ duration: this.inhaleTime * 1000, curve: Curve.EaseInOut }, () => {
      this.circleScale = 1.0
      this.circleOpacity = 0.8
    })
  }

  private animateHold(): void {
    // ä¿æŒä¸å˜
  }

  private animateExhale(): void {
    animateTo({ duration: this.exhaleTime * 1000, curve: Curve.EaseInOut }, () => {
      this.circleScale = 0.5
      this.circleOpacity = 0.3
    })
  }

  private finish(): void {
    if (this.timerId !== -1) { clearInterval(this.timerId); this.timerId = -1 }
    this.phase = 'å®Œæˆ'
    this.isRunning = false
  }

  private stop(): void {
    if (this.timerId !== -1) { clearInterval(this.timerId); this.timerId = -1 }
    this.isRunning = false
    this.phase = 'å‡†å¤‡'
    this.circleScale = 0.5
    this.circleOpacity = 0.3
  }

  private getPhaseColor(): ResourceColor {
    if (this.phase === 'å¸æ°”') return '#4CAF50'
    if (this.phase === 'å±æ°”') return '#FF9800'
    if (this.phase === 'å‘¼æ°”') return '#42A5F5'
    if (this.phase === 'å®Œæˆ') return '#66BB6A'
    return $r('app.color.primary_green')
  }

  private getRemainingPhaseSeconds(): number {
    if (this.phase === 'å¸æ°”') return this.inhaleTime - this.phaseSeconds
    if (this.phase === 'å±æ°”') return this.holdTime - this.phaseSeconds
    if (this.phase === 'å‘¼æ°”') return this.exhaleTime - this.phaseSeconds
    return 0
  }

  build() {
    Column() {
      Row() {
        Button('â†').width(40).height(40).fontSize(20)
          .backgroundColor($r('app.color.bg_surface')).fontColor($r('app.color.text_primary'))
          .borderRadius(20).onClick(() => { this.stop(); router.back() })
        Text('å‘¼å¸ç»ƒä¹ ').fontSize(20).fontWeight(FontWeight.Bold)
          .fontColor($r('app.color.text_primary')).margin({ left: 12 }).layoutWeight(1)
      }.width('100%').padding({ left: 16, right: 16, top: 12, bottom: 8 })
        .scale({ x: this.headerScale, y: this.headerScale }).opacity(this.headerOpacity)

      Column() {
        if (!this.isRunning && this.phase !== 'å®Œæˆ') {
          // é€‰æ‹©æ—¶é•¿
          Text('é€‰æ‹©ç»ƒä¹ æ—¶é•¿').fontSize(16).fontColor($r('app.color.text_secondary')).margin({ bottom: 16 })
          Row() {
            ForEach([1, 2, 3], (min: number) => {
              Button(`${min}åˆ†é’Ÿ`).height(40).fontSize(14)
                .backgroundColor(this.selectedDuration === min ? $r('app.color.primary_green') : $r('app.color.bg_surface'))
                .fontColor(this.selectedDuration === min ? Color.White : $r('app.color.text_secondary'))
                .borderRadius(20).margin({ left: 8, right: 8 })
                .onClick(() => { this.selectedDuration = min })
            })
          }.margin({ bottom: 32 })

          Text('å¸æ°”4ç§’ â†’ å±æ°”4ç§’ â†’ å‘¼æ°”6ç§’')
            .fontSize(13).fontColor($r('app.color.text_hint')).margin({ bottom: 32 })

          Button('å¼€å§‹å‘¼å¸').width('70%').height(52).fontSize(18).fontWeight(FontWeight.Bold)
            .fontColor(Color.White).backgroundColor($r('app.color.primary_green')).borderRadius(26)
            .onClick(() => { this.startBreathing() })

        } else if (this.phase === 'å®Œæˆ') {
          Text('ðŸŽ‰').fontSize(60).margin({ bottom: 16 })
          Text('å‘¼å¸ç»ƒä¹ å®Œæˆï¼').fontSize(24).fontWeight(FontWeight.Bold).fontColor($r('app.color.primary_green'))
          Text(`å®Œæˆ ${this.cycleCount} ä¸ªå‘¼å¸å¾ªçŽ¯`)
            .fontSize(14).fontColor($r('app.color.text_secondary')).margin({ top: 8, bottom: 32 })
          Button('å†æ¥ä¸€æ¬¡').width('60%').height(44).fontSize(16)
            .fontColor(Color.White).backgroundColor($r('app.color.primary_green')).borderRadius(22)
            .onClick(() => { this.phase = 'å‡†å¤‡'; this.circleScale = 0.5; this.circleOpacity = 0.3 })

        } else {
          // å‘¼å¸åŠ¨ç”»åœ†åœˆ
          Stack() {
            Circle().width(200).height(200)
              .fill(this.getPhaseColor())
              .opacity(this.circleOpacity)
              .scale({ x: this.circleScale, y: this.circleScale })

            Column() {
              Text(this.phase)
                .fontSize(28).fontWeight(FontWeight.Bold).fontColor(Color.White)
              Text(`${this.getRemainingPhaseSeconds()}`)
                .fontSize(48).fontWeight(FontWeight.Bold).fontColor(Color.White).margin({ top: 4 })
            }
          }
          .margin({ top: 20, bottom: 24 })

          Text(`ç¬¬ ${this.cycleCount + 1} ä¸ªå¾ªçŽ¯`)
            .fontSize(14).fontColor($r('app.color.text_secondary'))

          Text(`æ€»è®¡ ${Math.floor(this.totalSeconds / 60)}:${(this.totalSeconds % 60).toString().padStart(2, '0')}`)
            .fontSize(16).fontColor($r('app.color.text_primary')).fontWeight(FontWeight.Bold).margin({ top: 8 })

          Button('ç»“æŸ').width('50%').height(44).fontSize(16)
            .fontColor(Color.White).backgroundColor($r('app.color.error_red')).borderRadius(22)
            .margin({ top: 32 })
            .onClick(() => { this.finish() })
        }
      }
      .layoutWeight(1).justifyContent(FlexAlign.Center).alignItems(HorizontalAlign.Center)
      .scale({ x: this.bodyScale, y: this.bodyScale }).opacity(this.bodyOpacity)
    }
    .width('100%').height('100%').backgroundColor($r('app.color.bg_page'))
  }
}
