/**
 * ç¬”è®°åˆ›å»ºé¡µé¢ï¼ˆäºŒçº§é¡µé¢ï¼‰
 * ä¸ä½¿ç”¨è‡ªå®šä¹‰ç»„ä»¶ï¼Œæ‰€æœ‰ UI åœ¨ ArkUI ä¸­ç›´æ¥æ„å»º
 * æ”¯æŒä¸‰ç§ç±»å‹æ¨¡æ¿åŒ–è¾“å…¥ï¼šé•¿æœŸè®¡åˆ’ã€çŸ­æœŸå¤‡å¿˜ã€ä¸ªäººæ”¶è—
 */
import router from '@ohos.router'
import curves from '@ohos.curves'
import { PreferencesUtil } from '../utils/PreferencesUtil'
import { FocusNote, NoteType, NoteStatus } from '../model/DataModels'

interface NoteCreateParams {
  type: NoteType
}

@Entry
@Component
struct NoteCreatePage {
  @State noteType: NoteType = 'longterm'
  @State title: string = ''
  @State content: string = ''
  @State targetDateStr: string = ''
  @State status: NoteStatus = 'pending'
  @State url: string = ''

  // åŠ¨ç”»çŠ¶æ€
  @State headerScale: number = 0
  @State headerOpacity: number = 0
  @State formScale: number = 0
  @State formOpacity: number = 0
  @State buttonScale: number = 0
  @State buttonOpacity: number = 0

  private statusOptions: NoteStatus[] = ['pending', 'inprogress', 'completed']
  private statusLabels: string[] = ['å¾…å¼€å§‹', 'è¿›è¡Œä¸­', 'å·²å®Œæˆ']

  aboutToAppear(): void {
    let params = router.getParams() as NoteCreateParams
    if (params && params.type) {
      this.noteType = params.type
    }
    this.playEntranceAnimation()
  }

  private playEntranceAnimation(): void {
    setTimeout(() => {
      animateTo({
        duration: 700,
        curve: curves.springCurve(0, 1, 328, 34)
      }, () => {
        this.headerScale = 1
        this.headerOpacity = 1
      })
    }, 100)

    setTimeout(() => {
      animateTo({
        duration: 800,
        curve: curves.springCurve(0, 1, 300, 28)
      }, () => {
        this.formScale = 1
        this.formOpacity = 1
      })
    }, 250)

    setTimeout(() => {
      animateTo({
        duration: 600,
        curve: curves.springCurve(0, 1, 280, 26)
      }, () => {
        this.buttonScale = 1
        this.buttonOpacity = 1
      })
    }, 450)
  }

  private getTypeTitle(): string {
    if (this.noteType === 'longterm') return 'é•¿æœŸè®¡åˆ’'
    if (this.noteType === 'shortterm') return 'çŸ­æœŸå¤‡å¿˜'
    return 'ä¸ªäººæ”¶è—'
  }

  private async saveNote(): Promise<void> {
    if (this.title.trim() === '') return

    let targetDate = 0
    if (this.targetDateStr !== '') {
      targetDate = new Date(this.targetDateStr).getTime()
    }

    let note: FocusNote = {
      id: PreferencesUtil.generateId(),
      type: this.noteType,
      title: this.title.trim(),
      content: this.content.trim(),
      targetDate: targetDate,
      status: this.noteType === 'longterm' ? this.status : 'pending',
      url: this.url.trim(),
      createdAt: Date.now(),
      updatedAt: Date.now()
    }

    await PreferencesUtil.saveNote(note)
    router.back()
  }

  @Builder
  buildLongTermForm() {
    Column() {
      // æ ‡é¢˜
      Text('è®¡åˆ’æ ‡é¢˜')
        .fontSize(14)
        .fontColor($r('app.color.text_secondary'))
        .width('100%')
        .margin({ bottom: 6 })

      TextInput({ placeholder: 'è¾“å…¥è®¡åˆ’æ ‡é¢˜' })
        .width('100%')
        .height(48)
        .fontSize(15)
        .backgroundColor($r('app.color.bg_surface'))
        .borderRadius(12)
        .margin({ bottom: 16 })
        .onChange((value: string) => { this.title = value })

      // ç›®æ ‡æ—¥æœŸ
      Text('ç›®æ ‡æ—¥æœŸ')
        .fontSize(14)
        .fontColor($r('app.color.text_secondary'))
        .width('100%')
        .margin({ bottom: 6 })

      TextInput({ placeholder: 'YYYY-MM-DD' })
        .width('100%')
        .height(48)
        .fontSize(15)
        .backgroundColor($r('app.color.bg_surface'))
        .borderRadius(12)
        .margin({ bottom: 16 })
        .onChange((value: string) => { this.targetDateStr = value })

      // è¯¦ç»†å†…å®¹
      Text('è¯¦ç»†å†…å®¹')
        .fontSize(14)
        .fontColor($r('app.color.text_secondary'))
        .width('100%')
        .margin({ bottom: 6 })

      TextArea({ placeholder: 'æè¿°ä½ çš„é•¿æœŸè®¡åˆ’...' })
        .width('100%')
        .height(120)
        .fontSize(15)
        .backgroundColor($r('app.color.bg_surface'))
        .borderRadius(12)
        .margin({ bottom: 16 })
        .onChange((value: string) => { this.content = value })

      // çŠ¶æ€é€‰æ‹©
      Text('å½“å‰çŠ¶æ€')
        .fontSize(14)
        .fontColor($r('app.color.text_secondary'))
        .width('100%')
        .margin({ bottom: 8 })

      Row() {
        ForEach(this.statusLabels, (label: string, index: number) => {
          Button(label)
            .height(36)
            .fontSize(13)
            .backgroundColor(index !== undefined && this.status === this.statusOptions[index] ?
              $r('app.color.primary_green_light') : $r('app.color.bg_surface'))
            .fontColor(index !== undefined && this.status === this.statusOptions[index] ?
              $r('app.color.primary_green') : $r('app.color.text_secondary'))
            .borderRadius(18)
            .margin({ right: 10 })
            .onClick(() => {
              if (index !== undefined) {
                this.status = this.statusOptions[index]
              }
            })
        })
      }
      .width('100%')
    }
    .width('100%')
  }

  @Builder
  buildShortTermForm() {
    Column() {
      // æ ‡é¢˜
      Text('å¤‡å¿˜æ ‡é¢˜')
        .fontSize(14)
        .fontColor($r('app.color.text_secondary'))
        .width('100%')
        .margin({ bottom: 6 })

      TextInput({ placeholder: 'è¾“å…¥å¤‡å¿˜æ ‡é¢˜' })
        .width('100%')
        .height(48)
        .fontSize(15)
        .backgroundColor($r('app.color.bg_surface'))
        .borderRadius(12)
        .margin({ bottom: 16 })
        .onChange((value: string) => { this.title = value })

      // å†…å®¹
      Text('å¤‡å¿˜å†…å®¹')
        .fontSize(14)
        .fontColor($r('app.color.text_secondary'))
        .width('100%')
        .margin({ bottom: 6 })

      TextArea({ placeholder: 'å¿«é€Ÿè®°å½•ä½ çš„æƒ³æ³•ã€éœ€æ±‚ã€å¾…åŠ...' })
        .width('100%')
        .height(180)
        .fontSize(15)
        .backgroundColor($r('app.color.bg_surface'))
        .borderRadius(12)
        .onChange((value: string) => { this.content = value })
    }
    .width('100%')
  }

  @Builder
  buildFavoriteForm() {
    Column() {
      // æ ‡é¢˜
      Text('æ”¶è—æ ‡é¢˜')
        .fontSize(14)
        .fontColor($r('app.color.text_secondary'))
        .width('100%')
        .margin({ bottom: 6 })

      TextInput({ placeholder: 'ç»™æ”¶è—èµ·ä¸ªåå­—' })
        .width('100%')
        .height(48)
        .fontSize(15)
        .backgroundColor($r('app.color.bg_surface'))
        .borderRadius(12)
        .margin({ bottom: 16 })
        .onChange((value: string) => { this.title = value })

      // URL
      Text('ç½‘å€é“¾æ¥ (å¯é€‰)')
        .fontSize(14)
        .fontColor($r('app.color.text_secondary'))
        .width('100%')
        .margin({ bottom: 6 })

      TextInput({ placeholder: 'https://...' })
        .width('100%')
        .height(48)
        .fontSize(15)
        .backgroundColor($r('app.color.bg_surface'))
        .borderRadius(12)
        .margin({ bottom: 16 })
        .onChange((value: string) => { this.url = value })

      // æè¿°/æ–‡æœ¬ç‰‡æ®µ
      Text('æè¿°æˆ–æ–‡æœ¬ç‰‡æ®µ')
        .fontSize(14)
        .fontColor($r('app.color.text_secondary'))
        .width('100%')
        .margin({ bottom: 6 })

      TextArea({ placeholder: 'è¾“å…¥ä½ è¦æ”¶è—çš„å†…å®¹...' })
        .width('100%')
        .height(120)
        .fontSize(15)
        .backgroundColor($r('app.color.bg_surface'))
        .borderRadius(12)
        .onChange((value: string) => { this.content = value })
    }
    .width('100%')
  }

  build() {
    Column() {
      // å¯¼èˆªæ 
      Row() {
        Button('â†')
          .width(40)
          .height(40)
          .fontSize(20)
          .backgroundColor($r('app.color.bg_surface'))
          .fontColor($r('app.color.text_primary'))
          .borderRadius(20)
          .onClick(() => { router.back() })

        Text(`æ–°å»º${this.getTypeTitle()}`)
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor($r('app.color.text_primary'))
          .margin({ left: 12 })
          .layoutWeight(1)
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 12, bottom: 8 })
      .scale({ x: this.headerScale, y: this.headerScale })
      .opacity(this.headerOpacity)

      // è¡¨å•åŒºåŸŸ
      Scroll() {
        Column() {
          // ç±»å‹é€‰æ‹©æ ‡ç­¾
          Row() {
            Text('ğŸ“‹ é•¿æœŸè®¡åˆ’')
              .fontSize(13)
              .fontColor(this.noteType === 'longterm' ? $r('app.color.primary_green') : $r('app.color.text_hint'))
              .fontWeight(this.noteType === 'longterm' ? FontWeight.Bold : FontWeight.Normal)
              .padding({ left: 12, right: 12, top: 6, bottom: 6 })
              .backgroundColor(this.noteType === 'longterm' ? $r('app.color.primary_green_light') : $r('app.color.bg_surface'))
              .borderRadius(16)
              .onClick(() => { this.noteType = 'longterm' })
              .margin({ right: 8 })

            Text('âš¡ çŸ­æœŸå¤‡å¿˜')
              .fontSize(13)
              .fontColor(this.noteType === 'shortterm' ? $r('app.color.primary_blue') : $r('app.color.text_hint'))
              .fontWeight(this.noteType === 'shortterm' ? FontWeight.Bold : FontWeight.Normal)
              .padding({ left: 12, right: 12, top: 6, bottom: 6 })
              .backgroundColor(this.noteType === 'shortterm' ? $r('app.color.primary_blue_light') : $r('app.color.bg_surface'))
              .borderRadius(16)
              .onClick(() => { this.noteType = 'shortterm' })
              .margin({ right: 8 })

            Text('â­ ä¸ªäººæ”¶è—')
              .fontSize(13)
              .fontColor(this.noteType === 'favorite' ? $r('app.color.accent_orange') : $r('app.color.text_hint'))
              .fontWeight(this.noteType === 'favorite' ? FontWeight.Bold : FontWeight.Normal)
              .padding({ left: 12, right: 12, top: 6, bottom: 6 })
              .backgroundColor(this.noteType === 'favorite' ? $r('app.color.accent_orange_light') : $r('app.color.bg_surface'))
              .borderRadius(16)
              .onClick(() => { this.noteType = 'favorite' })
          }
          .width('100%')
          .margin({ bottom: 20 })

          // æ ¹æ®ç±»å‹æ˜¾ç¤ºä¸åŒè¡¨å•
          Column() {
            if (this.noteType === 'longterm') {
              this.buildLongTermForm()
            } else if (this.noteType === 'shortterm') {
              this.buildShortTermForm()
            } else {
              this.buildFavoriteForm()
            }
          }
          .width('100%')
          .padding(20)
          .backgroundColor($r('app.color.bg_card'))
          .borderRadius(20)
          .shadow({ radius: 8, color: $r('app.color.shadow_color'), offsetY: 2 })

          // ä¿å­˜æŒ‰é’®
          Button('ä¿å­˜')
            .width('80%')
            .height(48)
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor(Color.White)
            .backgroundColor($r('app.color.primary_green'))
            .borderRadius(24)
            .margin({ top: 28, bottom: 40 })
            .shadow({ radius: 8, color: $r('app.color.shadow_color'), offsetY: 4 })
            .onClick(() => { this.saveNote() })
            .scale({ x: this.buttonScale, y: this.buttonScale })
            .opacity(this.buttonOpacity)
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 8 })
        .scale({ x: this.formScale, y: this.formScale })
        .opacity(this.formOpacity)
      }
      .layoutWeight(1)
      .scrollBar(BarState.Off)
      .edgeEffect(EdgeEffect.Spring)
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('app.color.bg_page'))
  }
}
